<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mosaic Color Fraction Analyzer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&family=Space+Grotesk:wght@400;600&display=swap');

    :root {
      --bg-1: #f2efe7;
      --bg-2: #e6dfd0;
      --ink: #1c1a17;
      --accent: #d95f39;
      --accent-2: #2c6e6d;
      --card: #fffdf7;
      --shadow: rgba(0, 0, 0, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      color: var(--ink);
      background: radial-gradient(1200px 600px at 10% -10%, #f9f6ee 0%, transparent 60%),
                  radial-gradient(1000px 500px at 90% 10%, #efe3d2 0%, transparent 60%),
                  linear-gradient(160deg, var(--bg-1), var(--bg-2));
      font-family: "Space Grotesk", "Arial", sans-serif;
    }

    header {
      padding: 40px 20px 10px;
      max-width: 1100px;
      margin: 0 auto;
    }

    h1 {
      font-family: "Fraunces", "Georgia", serif;
      font-size: clamp(2rem, 5vw, 3.5rem);
      margin: 0 0 10px 0;
      letter-spacing: 0.5px;
    }

    p.lede {
      margin: 0;
      font-size: 1.1rem;
      max-width: 760px;
      line-height: 1.5;
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 20px 60px;
      display: grid;
      gap: 24px;
    }

    .panel {
      background: var(--card);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 18px 40px var(--shadow);
      border: 1px solid rgba(0,0,0,0.04);
    }

    .controls {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      align-items: end;
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
    }

    input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.15);
      font-size: 1rem;
      background: #fff;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }

    .range-wrap {
      display: grid;
      gap: 6px;
    }

    input[type="range"] {
      width: 100%;
    }

    .dropzone {
      border: 2px dashed var(--accent-2);
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      background: rgba(44, 110, 109, 0.05);
      transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
    }

    .dropzone.dragover {
      border-color: var(--accent);
      background: rgba(217, 95, 57, 0.12);
      transform: translateY(-2px);
    }

    .dropzone button {
      margin-top: 12px;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: white;
      font-weight: 600;
      cursor: pointer;
    }

    .results {
      display: grid;
      gap: 18px;
    }

    .card {
      border-radius: 16px;
      padding: 16px;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.06);
      display: grid;
      gap: 12px;
      animation: fadeIn 0.4s ease;
    }

    .card header {
      padding: 0;
    }

    .card h2 {
      font-size: 1.2rem;
      margin: 0;
    }

    .meta {
      font-size: 0.9rem;
      color: rgba(0,0,0,0.65);
    }

    .preview {
      display: flex;
      gap: 14px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .preview img {
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.1);
      max-width: 100%;
      height: auto;
      background: repeating-conic-gradient(#eee 0% 25%, #fafafa 0% 50%) 50% / 16px 16px;
    }

    .preview .alt {
      background: #ffffff;
    }

    .colors {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    .colors th,
    .colors td {
      text-align: left;
      padding: 6px 8px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .colors tfoot td {
      font-weight: 600;
    }

    .swatch {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,0.15);
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .empty {
      text-align: center;
      padding: 20px;
      font-size: 1rem;
      color: rgba(0,0,0,0.6);
    }

    @media (max-width: 720px) {
      .preview {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Mosaic Color Fraction Analyzer</h1>
    <p class="lede">Drop an image, choose the output size, and get per-color pixel fractions for mosaic planning.</p>
  </header>

  <main>
    <section class="panel">
      <div class="controls">
        <div>
          <label for="width">Width (feet)</label>
          <input id="width" type="number" min="0.1" step="0.1" value="10" />
        </div>
        <div>
          <label for="height">Height (feet)</label>
          <input id="height" type="number" min="0.1" step="0.1" value="10" />
        </div>
        <div>
          <label for="kgPerSqFt">kg / square foot</label>
          <input id="kgPerSqFt" type="number" min="0" step="0.1" value="1.5" />
        </div>
        <div class="range-wrap">
          <label for="topN">Top colors (N)</label>
          <input id="topN" type="range" min="2" max="50" value="12" />
          <div id="topNValue" class="meta">12 colors</div>
        </div>
        <div class="toggle">
          <input id="ignoreTransparent" type="checkbox" checked />
          <label for="ignoreTransparent">Ignore transparent pixels</label>
        </div>
      </div>
    </section>

    <section class="panel dropzone" id="dropzone">
      <div>
        <strong>Drag & drop an image here</strong>
        <div>or</div>
        <button id="pickButton" type="button">Choose an image</button>
        <input id="fileInput" type="file" accept="image/*" hidden />
      </div>
    </section>

    <section class="panel">
      <div id="results" class="results">
        <div class="empty">No images analyzed yet.</div>
      </div>
    </section>
  </main>

  <script>
    const dropzone = document.getElementById('dropzone');
    const pickButton = document.getElementById('pickButton');
    const fileInput = document.getElementById('fileInput');
    const results = document.getElementById('results');
    const widthInput = document.getElementById('width');
    const heightInput = document.getElementById('height');
    const kgPerSqFtInput = document.getElementById('kgPerSqFt');
    const topNInput = document.getElementById('topN');
    const topNValue = document.getElementById('topNValue');
    const ignoreTransparent = document.getElementById('ignoreTransparent');

    pickButton.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    topNInput.addEventListener('input', () => {
      topNValue.textContent = `${topNInput.value} colors`;
      recalculateAll();
    });
    ['change', 'input'].forEach(evt => {
      widthInput.addEventListener(evt, recalculateAll);
      heightInput.addEventListener(evt, recalculateAll);
      kgPerSqFtInput.addEventListener(evt, recalculateAll);
      ignoreTransparent.addEventListener(evt, recalculateAll);
    });

    ['dragenter', 'dragover'].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });
    });

    ['dragleave', 'drop'].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
      });
    });

    dropzone.addEventListener('drop', (e) => {
      handleFiles(e.dataTransfer.files);
    });

    function handleFiles(fileList) {
      const files = Array.from(fileList).filter(file => file.type.startsWith('image/'));
      files.forEach(processImage);
    }

    async function processImage(file) {
      const bitmap = await createImageBitmap(file);
      const maxDim = 400;
      const scale = Math.min(1, maxDim / Math.max(bitmap.width, bitmap.height));
      const targetWidth = Math.max(1, Math.round(bitmap.width * scale));
      const targetHeight = Math.max(1, Math.round(bitmap.height * scale));
      const canvas = document.createElement('canvas');
      canvas.width = targetWidth;
      canvas.height = targetHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bitmap, 0, 0, targetWidth, targetHeight);

      const imageData = ctx.getImageData(0, 0, targetWidth, targetHeight);
      const countsAll = new Map();
      const countsOpaque = new Map();
      let totalAll = 0;
      let totalOpaque = 0;

      for (let i = 0; i < imageData.data.length; i += 4) {
        const r = imageData.data[i];
        const g = imageData.data[i + 1];
        const b = imageData.data[i + 2];
        const a = imageData.data[i + 3];
        const key = a === 0 ? 'TRANSPARENT' : rgbToHex(r, g, b);
        countsAll.set(key, (countsAll.get(key) || 0) + 1);
        totalAll += 1;
        if (a !== 0) {
          countsOpaque.set(key, (countsOpaque.get(key) || 0) + 1);
          totalOpaque += 1;
        }
      }

      renderResult({
        fileName: file.name,
        totalAll,
        totalOpaque,
        previewUrl: canvas.toDataURL('image/png'),
        countsAll,
        countsOpaque,
        imageData,
        targetWidth,
        targetHeight
      });
    }

    function renderResult({ fileName, totalAll, totalOpaque, previewUrl, countsAll, countsOpaque, imageData, targetWidth, targetHeight }) {
      const card = document.createElement('article');
      card.className = 'card';
      card._data = { fileName, totalAll, totalOpaque, previewUrl, countsAll, countsOpaque, imageData, targetWidth, targetHeight };

      const header = document.createElement('header');
      header.innerHTML = `<h2>${escapeHtml(fileName)}</h2><div class="meta"></div>`;

      const preview = document.createElement('div');
      preview.className = 'preview';
      preview.innerHTML = `
        <img src="${previewUrl}" alt="${escapeHtml(fileName)} preview" width="${targetWidth}" height="${targetHeight}" />
        <img class="alt" src="${previewUrl}" alt="${escapeHtml(fileName)} highlight only" width="${targetWidth}" height="${targetHeight}" />
      `;

      card.appendChild(header);
      card.appendChild(preview);
      card.appendChild(document.createElement('table'));

      const empty = results.querySelector('.empty');
      if (empty) empty.remove();
      results.prepend(card);
      recalculateCard(card);
    }

    function rgbToHex(r, g, b) {
      return `#${[r, g, b].map(v => v.toString(16).padStart(2, '0')).join('')}`.toUpperCase();
    }

    function hexToRgb(hex) {
      const clean = hex.replace('#', '');
      return {
        r: parseInt(clean.slice(0, 2), 16),
        g: parseInt(clean.slice(2, 4), 16),
        b: parseInt(clean.slice(4, 6), 16)
      };
    }

    function highlightColor(imageData, width, height, colorHex) {
      const { r, g, b } = hexToRgb(colorHex);
      const masked = new ImageData(width, height);
      for (let i = 0; i < imageData.data.length; i += 4) {
        const rr = imageData.data[i];
        const gg = imageData.data[i + 1];
        const bb = imageData.data[i + 2];
        const aa = imageData.data[i + 3];

        if (rr === r && gg === g && bb === b) {
          masked.data[i] = rr;
          masked.data[i + 1] = gg;
          masked.data[i + 2] = bb;
          masked.data[i + 3] = aa;
        } else {
          const gray = Math.round(0.2126 * rr + 0.7152 * gg + 0.0722 * bb);
          masked.data[i] = gray;
          masked.data[i + 1] = gray;
          masked.data[i + 2] = gray;
          masked.data[i + 3] = Math.max(60, Math.round(aa * 0.4));
        }
      }
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.putImageData(masked, 0, 0);
      return canvas.toDataURL('image/png');
    }

    function highlightColorOnly(imageData, width, height, colorHex) {
      const { r, g, b } = hexToRgb(colorHex);
      const masked = new ImageData(width, height);
      for (let i = 0; i < imageData.data.length; i += 4) {
        const rr = imageData.data[i];
        const gg = imageData.data[i + 1];
        const bb = imageData.data[i + 2];
        const aa = imageData.data[i + 3];

        if (rr === r && gg === g && bb === b) {
          masked.data[i] = rr;
          masked.data[i + 1] = gg;
          masked.data[i + 2] = bb;
          masked.data[i + 3] = aa;
        } else {
          masked.data[i] = 255;
          masked.data[i + 1] = 255;
          masked.data[i + 2] = 255;
          masked.data[i + 3] = 255;
        }
      }
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.putImageData(masked, 0, 0);
      return canvas.toDataURL('image/png');
    }

    function clearSelections(table) {
      table.querySelectorAll('tbody tr').forEach(row => {
        row.dataset.selected = 'false';
      });
    }

    function recalculateAll() {
      results.querySelectorAll('.card').forEach(card => recalculateCard(card));
    }

    function recalculateCard(card) {
      const data = card._data;
      if (!data) return;
      const widthFeet = parseFloat(widthInput.value);
      const heightFeet = parseFloat(heightInput.value);
      if (!widthFeet || !heightFeet) return;
      const kgPerSqFt = parseFloat(kgPerSqFtInput.value) || 0;
      const topN = parseInt(topNInput.value, 10) || 10;
      const useOpaqueOnly = ignoreTransparent.checked;
      const area = widthFeet * heightFeet;

      const counts = useOpaqueOnly ? data.countsOpaque : data.countsAll;
      const total = useOpaqueOnly ? data.totalOpaque : data.totalAll;

      const sorted = total === 0 ? [] : Array.from(counts.entries())
        .map(([color, count]) => ({ color, count, fraction: count / total }))
        .sort((a, b) => b.count - a.count);

      const primary = sorted.slice(0, topN);
      const remainder = sorted.slice(topN);
      const otherCount = remainder.reduce((sum, row) => sum + row.count, 0);
      const rows = otherCount > 0
        ? [...primary, { color: 'OTHER', count: otherCount, fraction: otherCount / total }]
        : primary;

      const headerMeta = card.querySelector('.meta');
      headerMeta.textContent = `${widthFeet}×${heightFeet} ft • ${area.toFixed(2)} sq ft • ${total.toLocaleString()} pixels analyzed`;

      const previewImg = card.querySelector('.preview img');
      const previewAlt = card.querySelector('.preview img.alt');
      previewImg.src = data.previewUrl;
      previewAlt.src = data.previewUrl;

      const table = card.querySelector('.colors') || card.querySelector('table');
      table.className = 'colors';
      table.innerHTML = '';

      const head = document.createElement('thead');
      head.innerHTML = `<tr><th>Color</th><th>Fraction</th><th>Pixels</th><th>Mass (kg)</th></tr>`;
      table.appendChild(head);

      const body = document.createElement('tbody');
      let totalMass = 0;
      rows.forEach(row => {
        const tr = document.createElement('tr');
        const mass = row.fraction * area * kgPerSqFt;
        totalMass += mass;
        const isOther = row.color === 'OTHER' || row.color === 'TRANSPARENT';
        tr.innerHTML = `
          <td>${isOther ? '' : `<span class="swatch" style="background:${row.color}"></span>`}${row.color}</td>
          <td>${(row.fraction * 100).toFixed(2)}%</td>
          <td>${row.count.toLocaleString()}</td>
          <td>${mass.toFixed(2)}</td>
        `;
        if (!isOther) {
          tr.dataset.color = row.color;
          tr.style.cursor = 'pointer';
          tr.addEventListener('click', () => {
            const selected = tr.dataset.selected === 'true';
            clearSelections(table);
            if (!selected) {
              tr.dataset.selected = 'true';
              previewImg.src = highlightColor(data.imageData, data.targetWidth, data.targetHeight, row.color);
              previewAlt.src = highlightColorOnly(data.imageData, data.targetWidth, data.targetHeight, row.color);
            } else {
              previewImg.src = data.previewUrl;
              previewAlt.src = data.previewUrl;
            }
          });
        }
        body.appendChild(tr);
      });
      table.appendChild(body);

      const foot = document.createElement('tfoot');
      foot.innerHTML = `
        <tr>
          <td>Total</td>
          <td>100.00%</td>
          <td>${total.toLocaleString()}</td>
          <td>${totalMass.toFixed(2)}</td>
        </tr>
      `;
      table.appendChild(foot);
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"]/g, ch => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;'
      }[ch]));
    }
  </script>
</body>
</html>
